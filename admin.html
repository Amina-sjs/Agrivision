<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ | AgriVision</title>
    
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º API –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ü–ï–†–í–´–ú–ò -->
    <script src="js/config.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            overflow: hidden;
        }
        
        /* –û–≤–µ—Ä–ª–µ–π —Ñ–æ–Ω–∞ */
        #adminOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 9998;
        }
        
        /* –û—Å–Ω–æ–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å */
        #adminPanel {
            display: none;
            width: 100%;
            height: 100vh;
            overflow-y: auto;
            background: #f8f9fa;
            position: relative;
            z-index: 9999;
        }
        
        /* –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è */
        .active {
            display: block !important;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #2e7d32;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- –≠–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div id="loadingScreen" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div style="margin-left: 20px; font-size: 18px; color: #2e7d32;">
            –ó–∞–≥—Ä—É–∑–∫–∞ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏...
        </div>
    </div>
    
    <!-- –û–≤–µ—Ä–ª–µ–π —Ñ–æ–Ω–∞ -->
    <div id="adminOverlay" class="admin-panel-overlay"></div>
    
    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ -->
    <div id="adminPanel" class="admin-panel"></div>
    
    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω -->
    <div id="modalsContainer"></div>
    
    <!-- –û—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç –∞–¥–º–∏–Ω–∫–∏ -->
    <script src="admin.js"></script>
    
    <script>
    // –ù–û–í–´–ô –ö–û–î - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–¥–º–∏–Ω–∫–∏
    document.addEventListener('DOMContentLoaded', async function() {
        console.log('üöÄ –ó–∞–≥—Ä—É–∑–∫–∞ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ AgriVision...');
        
        // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        console.log('üë§ –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', currentUser);
        
        if (!currentUser) {
            alert('‚ö†Ô∏è –í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã!');
            window.location.href = 'index.html';
            return;
        }
        
        if (currentUser.role !== 'admin') {
            alert('üö´ –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω! –¢—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.');
            window.location.href = 'index.html';
            return;
        }
        
        console.log('‚úÖ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω:', currentUser.name);
        
        // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API
        let useAPI = false;
        
        // –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ API
        setTimeout(async () => {
            try {
                if (window.api && typeof api.checkConnection === 'function') {
                    console.log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API...');
                    useAPI = await api.checkConnection();
                    console.log(useAPI ? '‚úÖ API –¥–æ—Å—Ç—É–ø–µ–Ω' : '‚ùå API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
                }
            } catch (error) {
                console.log('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ API:', error);
                useAPI = false;
            }
            
            // 3. –°–æ–∑–¥–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
            if (!localStorage.getItem('agrivision_db')) {
                console.log('üìù –°–æ–∑–¥–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ...');
                const initialData = {
                    users: [
                        {
                            id: 1,
                            name: "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä",
                            email: "admin@agrivision.ru",
                            password: "AgriVision2024!",
                            phone: "+7 (900) 000-00-00",
                            role: "admin",
                            registrationDate: new Date().toISOString()
                        },
                        {
                            id: 2,
                            name: "–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
                            email: "test@test.com",
                            password: "123456",
                            phone: "+7 (999) 123-45-67",
                            role: "user",
                            registrationDate: new Date().toISOString()
                        }
                    ],
                    requests: [],
                    articles: [
                        {
                            id: 1,
                            title: "–ö–∞–∫ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –±–æ–ª–µ–∑–Ω—å —Ä–∞—Å—Ç–µ–Ω–∏–π –ø–æ –ª–∏—Å—Ç—å—è–º",
                            content: "–ü–æ–ª–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —Å—Ç–∞—Ç—å–∏ –æ –±–æ–ª–µ–∑–Ω—è—Ö —Ä–∞—Å—Ç–µ–Ω–∏–π...",
                            description: "–£–∑–Ω–∞–π—Ç–µ, –∫–∞–∫ –ø–æ –≤–Ω–µ—à–Ω–∏–º –ø—Ä–∏–∑–Ω–∞–∫–∞–º –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è —Å–µ–ª—å—Å–∫–æ—Ö–æ–∑—è–π—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∫—É–ª—å—Ç—É—Ä",
                            image: "https://images.unsplash.com/photo-1501004318641-b39e6451bec6",
                            category: "diseases",
                            date: new Date().toLocaleDateString('ru-RU'),
                            createdAt: new Date().toISOString(),
                            author: "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä",
                            views: 0,
                            isPublished: true
                        },
                        {
                            id: 2,
                            title: "–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –≤ —Å–µ–ª—å—Å–∫–æ–º —Ö–æ–∑—è–π—Å—Ç–≤–µ",
                            content: "–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —Å—Ç–∞—Ç—å–∏ –æ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è—Ö...",
                            description: "–û–±–∑–æ—Ä –Ω–æ–≤–µ–π—à–∏—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è —É—Ä–æ–∂–∞–π–Ω–æ—Å—Ç–∏",
                            image: "https://images.unsplash.com/photo-1625246333195-78d9c38ad449",
                            category: "agriculture",
                            date: new Date().toLocaleDateString('ru-RU'),
                            createdAt: new Date().toISOString(),
                            author: "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä",
                            views: 0,
                            isPublished: true
                        }
                    ],
                    analysis: [],
                    settings: {
                        siteName: "AgriVision",
                        contactEmail: "info@agrivision.ru",
                        supportPhone: "+7 (800) 123-45-67",
                        siteStatus: "active"
                    }
                };
                localStorage.setItem('agrivision_db', JSON.stringify(initialData));
                console.log('‚úÖ –ù–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–∑–¥–∞–Ω—ã');
            }
            
            // 4. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('adminOverlay').classList.add('active');
            document.getElementById('adminPanel').classList.add('active');
            
            // 5. –ó–∞–ø—É—Å–∫–∞–µ–º –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
            setTimeout(() => {
                if (typeof initAdminPanel === 'function') {
                    console.log('üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å...');
                    initAdminPanel();
                } else {
                    console.error('‚ùå –§—É–Ω–∫—Ü–∏—è initAdminPanel –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!');
                    document.getElementById('adminPanel').innerHTML = `
                        <div style="padding: 50px; text-align: center;">
                            <h1 style="color: #dc3545;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏!</h1>
                            <p>–§–∞–π–ª admin.js –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—à–∏–±–∫–∏.</p>
                            <p>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12 ‚Üí Console)</p>
                        </div>
                    `;
                }
            }, 500);
            
        }, 100);
    });
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤—Ö–æ–¥–∞ –∫–∞–∫ –∞–¥–º–∏–Ω (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
    window.loginAsAdmin = function() {
        localStorage.setItem('currentUser', JSON.stringify({
            id: 1,
            name: "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä",
            email: "admin@agrivision.ru",
            role: "admin"
        }));
        alert('–¢–µ—Å—Ç–æ–≤—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω! –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
        location.reload();
    };
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (—É–¥–∞–ª–∏—Ç—å –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ)
    setTimeout(() => {
        if (!localStorage.getItem('currentUser')) {
            const testBtn = document.createElement('button');
            testBtn.innerHTML = '<i class="fas fa-user-shield"></i> –¢–µ—Å—Ç: –í–æ–π—Ç–∏ –∫–∞–∫ –∞–¥–º–∏–Ω';
            testBtn.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: #2e7d32;
                color: white;
                border: none;
                padding: 10px 15px;
                border-radius: 5px;
                cursor: pointer;
                z-index: 10001;
            `;
            testBtn.onclick = window.loginAsAdmin;
            document.body.appendChild(testBtn);
        }
    }, 1000);
    </script>
</body>
</html>